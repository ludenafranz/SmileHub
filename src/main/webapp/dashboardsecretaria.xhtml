<ui:composition template="/WEB-INF/template/base.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:f="jakarta.faces.core"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:p="primefaces">

    <f:metadata>
        <f:viewAction action="#{userSession.checkLogin()}" />
    </f:metadata>

    <ui:define name="title-view">SMILEHUB - Dashboard Secretaría</ui:define>

    <ui:define name="content">
        <h:form id="dashForm">
            <p:growl id="msgs" showDetail="true" />

            <div class="dashboard-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0; color: #1e293b;">Bienvenida, #{userSession.user.name}</h2>
                        <p style="margin: 0; color: #64748b;">Panel de gestión de citas SmileHub</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <p:commandButton value="Nueva Cita" icon="pi pi-plus"
                                         styleClass="ui-button-primary"
                                         actionListener="#{citaController.prepararNuevaCita()}"
                                         update=":formDialogCita"
                                         oncomplete="PF('wdlgCita').show()" />

                        <p:commandButton value="Nuevo Paciente" icon="pi pi-user-plus"
                                         styleClass="ui-button-success"
                                         actionListener="#{citaController.prepararNuevaCita()}"
                                         update=":formNuevoPaciente"
                                         oncomplete="PF('wdlgPaciente').show()" />

                        <p:commandButton value="Nuevo Doctor" icon="pi pi-briefcase"
                                         styleClass="ui-button-info"
                                         oncomplete="PF('wdlgDoctor').show()" />

                        <p:commandButton value="Cerrar Sesión" icon="pi pi-sign-out"
                                         action="#{authenticationController.logout}"
                                         styleClass="ui-button-danger ui-button-flat"
                                         process="@this" />
                    </div>
                </div>

                <div class="kpi-container">
                    <div class="kpi-card bg-blue">
                        <span class="kpi-value">#{dashboardController.citasHoy}</span>
                        <span class="kpi-label">Citas Hoy</span>
                    </div>
                    <div class="kpi-card bg-yellow">
                        <span class="kpi-value">#{dashboardController.pendientes}</span>
                        <span class="kpi-label">Pendientes</span>
                    </div>
                    <div class="kpi-card bg-green">
                        <span class="kpi-value">#{dashboardController.realizadas}</span>
                        <span class="kpi-label">Realizadas</span>
                    </div>
                    <div class="kpi-card bg-purple">
                        <span class="kpi-value">#{dashboardController.nuevosPacientes}</span>
                        <span class="kpi-label">Nuevos Pacientes</span>
                    </div>
                </div>

                <div class="main-grid">
                    <div class="panel-white">
                        <h3 style="margin-top: 0; color: #334155;">Calendario de Citas</h3>
                        <p:calendar id="inline" mode="inline" style="width: 100%"/>
                    </div>

                    <div class="panel-white">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #334155;">Próximas Citas (Hoy)</h3>
                            <p:commandLink value="Ver todas" style="color: #2563eb; font-weight: 600;"/>
                        </div>

                        <ui:repeat value="#{dashboardController.proximasCitas}" var="cita">
                            <div class="cita-item" style="border-left-color: #{cita.color}; background: #{cita.bgColor};">
                                <div>
                                    <span style="font-weight: 700; color: #{cita.textColor}; font-size: 1.1rem;">
                                        #{cita.hora} - #{cita.tipo}
                                    </span><br/>
                                    <span style="color: #1e293b;">#{cita.pacienteNombre}</span>
                                </div>
                                <div style="text-align: right;">
                                    <p:commandButton icon="pi pi-pencil"
                                                     styleClass="ui-button-rounded ui-button-#{cita.buttonColor} ui-button-flat" />
                                </div>
                            </div>
                        </ui:repeat>
                    </div>
                </div>
            </div>
        </h:form>

        <p:dialog header="Agendar Nueva Cita" widgetVar="wdlgCita" modal="true"
                  responsive="true" width="500" showEffect="fade" hideEffect="fade">
            <h:form id="formDialogCita">
                <div class="ui-fluid">
                    <p:panel header="Datos de la Cita" style="margin-bottom:10px">
                        <div class="p-field" style="margin-bottom: 10px;">
                            <p:outputLabel for="fec" value="Fecha *" style="font-weight: bold;"/>
                            <p:datePicker id="fec" value="#{citaController.nuevaCita.fecha}" showIcon="true" required="true" />
                        </div>
                        <div class="p-field" style="margin-bottom: 10px;">
                            <p:outputLabel for="hor" value="Hora *" style="font-weight: bold;"/>
                            <p:datePicker id="hor" value="#{citaController.nuevaCita.hora}" timeOnly="true" pattern="HH:mm" required="true" />
                        </div>
                    </p:panel>

                    <p:panel header="Paciente y Doctor" styleClass="panel-odontologia">
                        <div class="p-field" style="margin-bottom: 10px;">
                            <p:outputLabel value="Paciente *" />
                            <p:selectOneMenu value="#{citaController.nuevaCita.paciente}" converter="entityConverter" filter="true">
                                <f:selectItem itemLabel="Seleccione Paciente" itemValue="#{null}" />
                                <f:selectItems value="#{citaController.listaPacientes}" var="p"
                                               itemLabel="#{p.nombres} #{p.apellidos}" itemValue="#{p}" />
                            </p:selectOneMenu>
                        </div>
                        <div class="p-field">
                            <p:outputLabel value="Doctor *" />
                            <p:selectOneMenu value="#{citaController.nuevaCita.doctor}" converter="entityConverter">
                                <f:selectItem itemLabel="Seleccione Doctor" itemValue="#{null}" />
                                <f:selectItems value="#{citaController.listaDoctores}" var="d"
                                               itemLabel="#{d.nombres} #{d.apellidos}" itemValue="#{d}" />
                            </p:selectOneMenu>
                        </div>
                    </p:panel>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <p:commandButton value="Agendar Cita" icon="pi pi-check"
                                     actionListener="#{citaController.agendarCita()}"
                                     update=":dashForm:msgs"
                                     oncomplete="if (!args.validationFailed) PF('wdlgCita').hide()" />
                </div>
            </h:form>
        </p:dialog>

        <p:dialog header="Registrar Nuevo Paciente" widgetVar="wdlgPaciente" modal="true" width="450">
            <h:form id="formNuevoPaciente">
                <div class="ui-fluid">
                    <p:inputText value="#{citaController.nuevaCita.paciente.nombres}" placeholder="Nombres *" style="margin-bottom:10px"/>
                    <p:inputText value="#{citaController.nuevaCita.paciente.apellidos}" placeholder="Apellidos *" style="margin-bottom:10px"/>
                    <p:inputText value="#{citaController.nuevaCita.paciente.numeroIdentificacion}" placeholder="Identificación *" style="margin-bottom:10px"/>
                    <p:inputText value="#{citaController.nuevaCita.paciente.telefono}" placeholder="Teléfono" style="margin-bottom:10px"/>
                    <p:inputText value="#{citaController.nuevaCita.paciente.correo}" placeholder="Correo Electrónico" style="margin-bottom:10px"/>

                    <p:commandButton value="Guardar Paciente" icon="pi pi-save"
                                     actionListener="#{citaController.registrarYSeleccionarPaciente()}"
                                     update=":formDialogCita:selPac, :dashForm:msgs"
                                     styleClass="ui-button-success"
                                     oncomplete="PF('wdlgPaciente').hide()" />
                </div>
            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>